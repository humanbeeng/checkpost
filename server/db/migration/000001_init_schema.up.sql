CREATE TYPE "plan" AS ENUM (
  'guest',
  'free',
  'no_brainer',
  'pro'
);

CREATE TYPE "http_method" AS ENUM (
  'get',
  'post',
  'put',
  'patch',
  'delete',
  'options',
  'head',
  'trace',
  'connect'
);

CREATE TABLE "users" (
  "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "name" text NOT NULL,
  "plan" plan NOT NULL,
  "email" varchar(60) UNIQUE NOT NULL,
  "created_at" timestamp DEFAULT (now())
);

CREATE TABLE "urls" (
  "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "url" text NOT NULL,
  "user_id" bigint NOT NULL,
  "created_at" timestamp DEFAULT (now())
);

CREATE TABLE "requests" (
  "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "user_id" bigint NOT NULL,
  "content" text,
  "method" http_method NOT NULL,
  "source_ip" text NOT NULL,
  "content_size" int NOT NULL DEFAULT 0,
  "response_code" int,
  "headers" jsonb,
  "query_params" jsonb,
  "created_at" timestamp DEFAULT (now())
);

CREATE TABLE "file_attachments" (
  "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "url" text NOT NULL,
  "user_id" bigint,
  "created_at" timestamp DEFAULT (now())
);

CREATE TABLE "responses" (
  "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "user_id" bigint NOT NULL,
  "response_code" int NOT NULL DEFAULT 200,
  "content" text,
  "created_at" timestamp DEFAULT (now())
);

COMMENT ON COLUMN "requests"."source_ip" IS 'IPv4';

ALTER TABLE "urls" ADD FOREIGN KEY ("user_id") REFERENCES "users" ("id");

ALTER TABLE "requests" ADD FOREIGN KEY ("user_id") REFERENCES "users" ("id");

ALTER TABLE "file_attachments" ADD FOREIGN KEY ("user_id") REFERENCES "users" ("id");

ALTER TABLE "responses" ADD FOREIGN KEY ("user_id") REFERENCES "users" ("id");
